{% extends "base.html" %}
{% block title %}Risultati #{{ run.id }} - Monitor Bot{% endblock %}

{% block content %}
<div class="mb-8">
    <a href="/history" class="inline-flex items-center gap-1 text-sm text-gray-500 hover:text-navy-800 mb-3">
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        Torna allo storico
    </a>
    <h1 class="text-2xl font-bold text-navy-800">Risultati del {{ run.started_at.strftime('%d/%m/%Y alle %H:%M') }}</h1>
    <div class="mt-2 flex items-center gap-4">
        {% if run.status.value == 'completed' %}
        <span class="inline-flex items-center rounded-full bg-emerald-50 px-2.5 py-0.5 text-xs font-medium text-emerald-700">Completato</span>
        {% elif run.status.value == 'failed' %}
        <span class="inline-flex items-center rounded-full bg-red-50 px-2.5 py-0.5 text-xs font-medium text-red-700">Errore</span>
        {% endif %}
        <span class="text-sm text-gray-500">{{ run.total_collected }} raccolti &middot; {{ run.total_classified }} classificati &middot; {{ run.total_relevant }} rilevanti</span>
        {% if run.elapsed_seconds %}
        <span class="text-sm text-gray-400">{{ "%.0f"|format(run.elapsed_seconds) }}s</span>
        {% endif %}
    </div>
</div>

{% if run.results %}
<div x-data="{ typeFilter: 'all', catFilter: 'all', sortBy: 'score' }">

    <!-- Filters -->
    <div class="mb-6 flex flex-wrap items-center gap-3">
        <div class="flex gap-1 rounded-lg border border-gray-200 bg-white p-1">
            <button @click="typeFilter = 'all'" :class="typeFilter === 'all' ? 'bg-navy-800 text-white' : 'text-gray-600 hover:bg-gray-100'" class="rounded-md px-3 py-1.5 text-xs font-medium transition-colors">Tutti</button>
            <button @click="typeFilter = 'Bando'" :class="typeFilter === 'Bando' ? 'bg-navy-800 text-white' : 'text-gray-600 hover:bg-gray-100'" class="rounded-md px-3 py-1.5 text-xs font-medium transition-colors">Bandi</button>
            <button @click="typeFilter = 'Evento'" :class="typeFilter === 'Evento' ? 'bg-navy-800 text-white' : 'text-gray-600 hover:bg-gray-100'" class="rounded-md px-3 py-1.5 text-xs font-medium transition-colors">Eventi</button>
            <button @click="typeFilter = 'Concorso'" :class="typeFilter === 'Concorso' ? 'bg-navy-800 text-white' : 'text-gray-600 hover:bg-gray-100'" class="rounded-md px-3 py-1.5 text-xs font-medium transition-colors">Concorsi</button>
        </div>
        <div class="flex gap-1 rounded-lg border border-gray-200 bg-white p-1">
            <button @click="catFilter = 'all'" :class="catFilter === 'all' ? 'bg-navy-800 text-white' : 'text-gray-600 hover:bg-gray-100'" class="rounded-md px-3 py-1.5 text-xs font-medium transition-colors">Tutte</button>
            <button @click="catFilter = 'SAP'" :class="catFilter === 'SAP' ? 'bg-navy-800 text-white' : 'text-gray-600 hover:bg-gray-100'" class="rounded-md px-3 py-1.5 text-xs font-medium transition-colors">SAP</button>
            <button @click="catFilter = 'Data'" :class="catFilter === 'Data' ? 'bg-navy-800 text-white' : 'text-gray-600 hover:bg-gray-100'" class="rounded-md px-3 py-1.5 text-xs font-medium transition-colors">Data</button>
            <button @click="catFilter = 'AI'" :class="catFilter === 'AI' ? 'bg-navy-800 text-white' : 'text-gray-600 hover:bg-gray-100'" class="rounded-md px-3 py-1.5 text-xs font-medium transition-colors">AI</button>
            <button @click="catFilter = 'Cloud'" :class="catFilter === 'Cloud' ? 'bg-navy-800 text-white' : 'text-gray-600 hover:bg-gray-100'" class="rounded-md px-3 py-1.5 text-xs font-medium transition-colors">Cloud</button>
        </div>
    </div>

    <!-- Results -->
    <div class="space-y-4">
        {% for r in run.results|sort(attribute='relevance_score', reverse=True) %}
        <div x-show="(typeFilter === 'all' || typeFilter === '{{ r.opportunity_type }}') && (catFilter === 'all' || catFilter === '{{ r.category }}')"
             class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm transition-all hover:shadow-md">
            <div class="flex items-start justify-between gap-4">
                <div class="min-w-0 flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="inline-flex items-center justify-center h-7 w-7 rounded-lg text-xs font-bold
                            {% if r.relevance_score >= 8 %}bg-emerald-100 text-emerald-800
                            {% elif r.relevance_score >= 6 %}bg-accent-100 text-accent-800
                            {% elif r.relevance_score >= 4 %}bg-amber-100 text-amber-800
                            {% else %}bg-gray-100 text-gray-600{% endif %}">{{ r.relevance_score }}</span>
                        <h3 class="text-base font-semibold text-navy-800 truncate">{{ r.title }}</h3>
                    </div>
                    <p class="text-sm text-gray-600 line-clamp-2 mb-3">{{ r.description }}</p>

                    <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-gray-500">
                        {% if r.opportunity_type == 'Bando' %}
                        <span class="inline-flex items-center gap-1"><span class="h-1.5 w-1.5 rounded-full bg-amber-500"></span> Bando</span>
                        {% elif r.opportunity_type == 'Evento' %}
                        <span class="inline-flex items-center gap-1"><span class="h-1.5 w-1.5 rounded-full bg-violet-500"></span> Evento</span>
                        {% else %}
                        <span class="inline-flex items-center gap-1"><span class="h-1.5 w-1.5 rounded-full bg-blue-500"></span> Concorso</span>
                        {% endif %}

                        {% if r.category %}
                        <span class="rounded bg-gray-100 px-1.5 py-0.5 font-medium">{{ r.category }}</span>
                        {% endif %}
                        {% if r.event_format %}
                        <span class="rounded bg-orange-50 px-1.5 py-0.5 font-medium text-orange-700">{{ r.event_format }}</span>
                        {% endif %}
                        {% if r.event_cost %}
                        <span class="rounded bg-green-50 px-1.5 py-0.5 font-medium text-green-700">{{ r.event_cost }}</span>
                        {% endif %}
                        {% if r.sector %}
                        <span class="rounded bg-slate-100 px-1.5 py-0.5 font-medium text-slate-700">{{ r.sector }}</span>
                        {% endif %}
                        {% if r.contracting_authority %}
                        <span>{{ r.contracting_authority }}</span>
                        {% endif %}
                        {% if r.city or r.country %}
                        <span>{{ [r.city, r.country]|select|join(', ') }}</span>
                        {% endif %}
                        {% if r.deadline %}
                        <span class="font-medium {% if r.deadline < today %}text-red-500{% else %}text-navy-800{% endif %}">Scadenza: {{ r.deadline.strftime('%d/%m/%Y') }}</span>
                        {% endif %}
                        {% if r.estimated_value %}
                        <span class="font-medium text-navy-800">{{ "{:,.0f}".format(r.estimated_value) }} {{ r.currency }}</span>
                        {% endif %}
                        {% if r.opportunity_type != 'Evento' %}
                        <span class="text-gray-400">{{ r.source }}</span>
                        {% endif %}
                    </div>
                </div>
                {% if r.source_url %}
                <a href="{{ r.source_url }}" target="_blank" class="flex-shrink-0 rounded-lg border border-gray-200 p-2 text-gray-400 hover:border-accent-300 hover:text-accent-600 transition-colors">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                </a>
                {% endif %}
            </div>

            {% if r.ai_reasoning %}
            <div class="mt-4 rounded-lg bg-gray-50 px-4 py-3">
                <p class="text-xs font-medium text-gray-500 mb-1">Analisi AI</p>
                <p class="text-sm text-gray-700">{{ r.ai_reasoning }}</p>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<div class="rounded-xl border border-gray-200 bg-white px-6 py-16 text-center shadow-sm">
    <p class="text-sm text-gray-500">Nessun risultato per questa esecuzione.</p>
</div>
{% endif %}
{% endblock %}
